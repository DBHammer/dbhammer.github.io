<!DOCTYPE html>
<html lang="en" data-dark="false">
  <head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <!--
  put your analytics (e.g. Google Analytics) tracking code here
-->

  <!--
  put your search engine verification (e.g. Google Search Console) tag here
-->

  






























<meta name="viewport" content="width=device-width, initial-scale=1">

<title>ä»æŸ¥è¯¢æ ‘çš„ç”Ÿæˆåˆ°æŸ¥è¯¢æ‰§è¡Œ â€” ä»¥Index Nested Loop Joinä¸ºä¾‹ | DBHammer</title>

<link rel="icon" href="">

<meta name="title" content="ä»æŸ¥è¯¢æ ‘çš„ç”Ÿæˆåˆ°æŸ¥è¯¢æ‰§è¡Œ â€” ä»¥Index Nested Loop Joinä¸ºä¾‹">
<meta name="description" content="DaSE, ECNU. The official website of DBHammer, DaSE, ECNU.">

<meta property="og:title" content="ä»æŸ¥è¯¢æ ‘çš„ç”Ÿæˆåˆ°æŸ¥è¯¢æ‰§è¡Œ â€” ä»¥Index Nested Loop Joinä¸ºä¾‹">
<meta property="og:site_title" content="DBHammer">
<meta property="og:description" content="DaSE, ECNU. The official website of DBHammer, DaSE, ECNU.">
<meta property="og:url" content="https://dbhammer.github.io">
<meta property="og:image" content="">
<meta property="og:locale" content="en_US">

<meta property="twitter:title" content="ä»æŸ¥è¯¢æ ‘çš„ç”Ÿæˆåˆ°æŸ¥è¯¢æ‰§è¡Œ â€” ä»¥Index Nested Loop Joinä¸ºä¾‹">
<meta property="twitter:description" content="DaSE, ECNU. The official website of DBHammer, DaSE, ECNU.">
<meta property="twitter:url" content="https://dbhammer.github.io">
<meta property="twitter:card" content="summary_large_image">
<meta property="twitter:image" content="">


  <meta name="author" content="èƒ¡æ¢“é”">
  <meta property="og:type" content="article">
  <meta property="og:updated_time" content="2025-03-26T07:14:45+00:00">
  <meta property="article:published_time" content="2022-05-11T00:00:00+00:00">
  <meta property="article:modified_time" content="2025-03-26T07:14:45+00:00">
  <meta name="revised" content="2025-03-26T07:14:45+00:00">


<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "BlogPosting",
      "author": { "@type": "Person", "name": "ä»æŸ¥è¯¢æ ‘çš„ç”Ÿæˆåˆ°æŸ¥è¯¢æ‰§è¡Œ â€” ä»¥Index Nested Loop Joinä¸ºä¾‹" },
      "datePublished": "2022-05-11T00:00:00+00:00",
      "dateModified": "2025-03-26T07:14:45+00:00",
    
    "name": "ä»æŸ¥è¯¢æ ‘çš„ç”Ÿæˆåˆ°æŸ¥è¯¢æ‰§è¡Œ â€” ä»¥Index Nested Loop Joinä¸ºä¾‹",
    "description": "DaSE, ECNU. The official website of DBHammer, DaSE, ECNU.",
    "headline": "ä»æŸ¥è¯¢æ ‘çš„ç”Ÿæˆåˆ°æŸ¥è¯¢æ‰§è¡Œ â€” ä»¥Index Nested Loop Joinä¸ºä¾‹",
    "publisher": {
      "@type": "Organization",
      "logo": { "@type": "ImageObject", "url": "" }
    },
    "url": "https://dbhammer.github.io"
  }
</script>

<link rel="alternate" type="application/rss+xml" href="https://dbhammer.github.io/feed.xml">

  <!-- Google Fonts -->
<!-- automatically get url from fonts used in theme file -->

<link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?display=swap&&family=Barlow:ital,wght@0,200;0,400;0,500;0,600;1,200;1,400;1,500;1,600&amp;family=Roboto+Mono:ital,wght@0,200;0,400;0,500;0,600;1,200;1,400;1,500;1,600" rel="stylesheet">

<!-- Font Awesome icons (load asynchronously due to size) -->

<link href="https://use.fontawesome.com/releases/v6.7.0/css/all.css" rel="stylesheet" media="none" onload="this.removeAttribute('media'); this.onload = null;">
<noscript>
  <link href="https://use.fontawesome.com/releases/v6.7.0/css/all.css" rel="stylesheet">
</noscript>

  <!-- third party styles -->
<!-- https://stylishthemes.github.io/Syntax-Themes/pygments/ -->
<link href="https://cdn.jsdelivr.net/gh/StylishThemes/Syntax-Themes/pygments/css-github/pygments-tomorrow-night-eighties.css" rel="stylesheet">

<!-- include all sass in styles folder -->


  
    <link href="/_styles/-theme.css" rel="stylesheet">
  

  
    <link href="/_styles/alert.css" rel="stylesheet">
  

  
    <link href="/_styles/all.css" rel="stylesheet">
  

  
    <link href="/_styles/anchor.css" rel="stylesheet">
  

  
    <link href="/_styles/background.css" rel="stylesheet">
  

  
    <link href="/_styles/banner.css" rel="stylesheet">
  

  
    <link href="/_styles/blog-article.css" rel="stylesheet">
  

  
    <link href="/_styles/body.css" rel="stylesheet">
  

  
    <link href="/_styles/bold.css" rel="stylesheet">
  

  
    <link href="/_styles/button.css" rel="stylesheet">
  

  
    <link href="/_styles/card.css" rel="stylesheet">
  

  
    <link href="/_styles/checkbox.css" rel="stylesheet">
  

  
    <link href="/_styles/citation.css" rel="stylesheet">
  

  
    <link href="/_styles/code.css" rel="stylesheet">
  

  
    <link href="/_styles/cols.css" rel="stylesheet">
  

  
    <link href="/_styles/dark-toggle.css" rel="stylesheet">
  

  
    <link href="/_styles/details.css" rel="stylesheet">
  

  
    <link href="/_styles/feature.css" rel="stylesheet">
  

  
    <link href="/_styles/figure.css" rel="stylesheet">
  

  
    <link href="/_styles/float.css" rel="stylesheet">
  

  
    <link href="/_styles/font.css" rel="stylesheet">
  

  
    <link href="/_styles/footer.css" rel="stylesheet">
  

  
    <link href="/_styles/form.css" rel="stylesheet">
  

  
    <link href="/_styles/gallery.css" rel="stylesheet">
  

  
    <link href="/_styles/grid.css" rel="stylesheet">
  

  
    <link href="/_styles/header.css" rel="stylesheet">
  

  
    <link href="/_styles/heading.css" rel="stylesheet">
  

  
    <link href="/_styles/highlight.css" rel="stylesheet">
  

  
    <link href="/_styles/icon.css" rel="stylesheet">
  

  
    <link href="/_styles/image.css" rel="stylesheet">
  

  
    <link href="/_styles/input.css" rel="stylesheet">
  

  
    <link href="/_styles/link.css" rel="stylesheet">
  

  
    <link href="/_styles/list.css" rel="stylesheet">
  

  
    <link href="/_styles/main.css" rel="stylesheet">
  

  
    <link href="/_styles/member-intro.css" rel="stylesheet">
  

  
    <link href="/_styles/paragraph.css" rel="stylesheet">
  

  
    <link href="/_styles/portrait.css" rel="stylesheet">
  

  
    <link href="/_styles/post-excerpt.css" rel="stylesheet">
  

  
    <link href="/_styles/post-info.css" rel="stylesheet">
  

  
    <link href="/_styles/post-nav.css" rel="stylesheet">
  

  
    <link href="/_styles/quote.css" rel="stylesheet">
  

  
    <link href="/_styles/role.css" rel="stylesheet">
  

  
    <link href="/_styles/rule.css" rel="stylesheet">
  

  
    <link href="/_styles/search-box.css" rel="stylesheet">
  

  
    <link href="/_styles/search-info.css" rel="stylesheet">
  

  
    <link href="/_styles/section.css" rel="stylesheet">
  

  
    <link href="/_styles/table.css" rel="stylesheet">
  

  
    <link href="/_styles/tags.css" rel="stylesheet">
  

  
    <link href="/_styles/textbox.css" rel="stylesheet">
  

  
    <link href="/_styles/tooltip.css" rel="stylesheet">
  

  
    <link href="/_styles/two-col.css" rel="stylesheet">
  

  
    <link href="/_styles/util.css" rel="stylesheet">
  


<!-- include all css in styles folder -->



  <!-- third party scripts -->
<script src="https://unpkg.com/@popperjs/core@2" defer></script>
<script src="https://unpkg.com/tippy.js@6" defer></script>
<script src="https://unpkg.com/mark.js@8" defer></script>

<!-- include all js in scripts folder -->


  <script src="/_scripts/anchors.js"></script>

  <script src="/_scripts/dark-mode.js"></script>

  <script src="/_scripts/fetch-tags.js"></script>

  <script src="/_scripts/search.js"></script>

  <script src="/_scripts/site-search.js"></script>

  <script src="/_scripts/table-wrap.js"></script>

  <script src="/_scripts/tooltip.js"></script>

  <script src="/_scripts/tooltips.js"></script>

  <script src="/_scripts/true-hide.js"></script>

  <script src="/_scripts/util.js"></script>


</head>

  <body>
    







<header class="background" style="--image: url('')" data-dark="true">
  <a href="/" class="home">
    
      <span class="logo">
        
          <svg xmlns="http://www.w3.org/2000/svg" viewbox="-50 -50 100 100" style="overflow: visible">
  <style>
  circle {
    animation: float 2s ease-out forwards infinite,
    fade 2s ease-out forwards infinite;
  }
  circle:nth-of-type(1) {
    animation-delay: 0.1s;
  }
  circle:nth-of-type(2) {
    animation-delay: 0.4s;
  }
  circle:nth-of-type(3) {
    animation-delay: 1.1s;
  }
  @keyframes float {
    50% {
      transform: translateY(0);
    }
    100% {
      transform: translateY(-45px);
    }
  }
  @keyframes fade {
    75% {
      opacity: 1;
    }
    100% {
      opacity: 0;
    }
  }
  </style>
  <circle fill="#b3e5fc" cx="0" cy="0" r="3"></circle>
  <circle fill="#b3e5fc" cx="0" cy="0" r="3"></circle>
  <circle fill="#b3e5fc" cx="0" cy="0" r="3"></circle>
  <path fill="#81d4fa" d="
      M 0.0 -15.0
      L -21.7 -2.5
      L -21.7 22.5
      L -0.0 35.0
      L 21.7 22.5
      L 21.7 -2.5
      z
    "></path>
  <path fill="#b3e5fc" d="
      M 0.0 -15.0
      L -21.7 -2.5
      L 0 10
      L 21.7 -2.5
      z
    "></path>
  <path fill="none" stroke="#ffffff" stroke-width="5" stroke-linecap="round" stroke-linejoin="round" d="
      M -15 -43
      L -10 -43
      L -10 -19.2
      L -30.3 -7.5
      L -30.3 27.5
      L -0 45
      L 30.3 27.5
      L 30.3 -7.5
      L 10 -19.2
      L 10 -43
      L 15 -43
    "></path>
</svg>

        
      </span>
    
    
      <span class="title-text" data-tooltip="Home">
        
          <span class="title">DBHammer</span>
        
        
          <span class="subtitle">DaSE, ECNU</span>
        
      </span>
    
  </a>

  <input class="nav-toggle" type="checkbox" aria-label="show/hide nav">

  <nav>
    
    
      
        <a href="/project/" data-tooltip="Software, datasets, and more">
          é¡¹ç›®
        </a>
      
    
      
        <a href="/blog/" data-tooltip="Musings and miscellany">
          åšå®¢
        </a>
      
    
      
        <a href="/research/" data-tooltip="Published works">
          è®ºæ–‡
        </a>
      
    
      
        <a href="/news/" data-tooltip="News">
          æ–°é—»
        </a>
      
    
      
        <a href="/team/" data-tooltip="About our team">
          æˆå‘˜
        </a>
      
    
      
        <a href="/contact/" data-tooltip="Email, address, and location">
          è”ç³»æˆ‘ä»¬
        </a>
      
    
  </nav>
</header>

    <main>
      <!--
  modify main content of page:
  - add section breaks
  - attach section properties
  - filter out blank sections
-->






  
  
  

  <section class="background" data-size="1">
    <!--
  background: ;
  dark: ;
  size: 1;
-->


<h1 class="center">ä»æŸ¥è¯¢æ ‘çš„ç”Ÿæˆåˆ°æŸ¥è¯¢æ‰§è¡Œ â€” ä»¥Index Nested Loop Joinä¸ºä¾‹</h1>

<div class="post-info">
  
    
    
      



<div class="portrait-wrapper">
  <a href="/members/%E8%83%A1%E6%A2%93%E9%94%90.html" class="portrait" data-style="tiny" aria-label="èƒ¡æ¢“é”">
    
      <i class="icon fas fa-graduation-cap"></i>
    

    <img src="/photos/huzirui.jpg" class="portrait-image" alt="member portrait" loading="lazy" onerror="this.src = '/images/fallback.svg'; this.onerror = null;">

    
      <span class="portrait-name">
        èƒ¡æ¢“é”
      </span>
    

    
      <span class="portrait-description">
        
      </span>
    

    
  </a>
</div>

    
  

  
  

  
    <span data-tooltip="Originally published on">
      <i class="icon fa-regular fa-calendar"></i>
      <span>May 11, 2022</span>
    </span>
  

  
    <span data-tooltip="Last updated on">
      <i class="icon fa-solid fa-clock-rotate-left"></i>
      <span>March 26, 2025</span>
    </span>
  
</div>


  


  <div class="tags" data-link="/blog">
    
      <a href="blog?search=%22tag:%20query%22" class="tag" data-tooltip='Show items with the tag "query"'>
        query
      </a>
    
  </div>
  </section>

  
  
  

  <section class="background" data-size="page">
    <!--
  background: ;
  dark: ;
  size: ;
-->


<blockquote>
  <p>ğŸ’¡ <strong>ä½œè€…ï¼šåä¸œå¸ˆèŒƒå¤§å­¦ æ•°æ®ç§‘å­¦ä¸å·¥ç¨‹å­¦é™¢ DBHammeré¡¹ç›®ç»„ ä¸œäºšç”·å„¿å›¢é˜Ÿ</strong></p>
</blockquote>

<p>æœ¬æ–‡ä¸»ä½“é¢å‘å¯¹OceanBaseæ•°æ®åº“æºç ä»¥åŠç³»ç»Ÿæ€§èƒ½ä¼˜åŒ–æ„Ÿå…´è¶£çš„åˆå­¦è€…ä¾›ä»¥æŠ€æœ¯äº¤æµï¼Œç¬”è€…æ¥è‡ª<a href="https://dbhammer.github.io/">åä¸œå¸ˆèŒƒå¤§å­¦æ•°æ®ç§‘å­¦ä¸å·¥ç¨‹å­¦é™¢DBHammeré¡¹ç›®ç»„</a>ã€‚</p>

<p>åœ¨OceanBaseæ•°æ®åº“å¤§èµ›çš„å¤èµ›é˜¶æ®µï¼Œæˆ‘ä»¬éœ€è¦å¯¹OceanBase 3.1ç‰ˆæœ¬çš„Nested Loop Joinï¼ˆä¸‹ç§°NLJï¼‰è¿™ä¸€åŠŸèƒ½è¿›è¡Œä¼˜åŒ–ã€‚å› æ­¤ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬ä»¥NLJä¸ºä¾‹ï¼Œç®€è¦ä»‹ç»æˆ‘ä»¬å¯¹OBä»æŸ¥è¯¢æ ‘çš„ç”Ÿæˆåˆ°æŸ¥è¯¢æ‰§è¡Œçš„ä¸€äº›è®¤è¯†ã€‚æ–‡ç« ä¸»è¦ä»OBçš„åŸºç¡€ä»£ç ç»„ç»‡é€»è¾‘ã€æŸ¥è¯¢æ ‘çš„ç”Ÿæˆå’ŒæŸ¥è¯¢æ‰§è¡Œä¸‰ä¸ªæ–¹é¢è¿›è¡Œä»‹ç»ã€‚</p>

<h2 id="obçš„ä»£ç ç»„ç»‡é€»è¾‘">OBçš„ä»£ç ç»„ç»‡é€»è¾‘</h2>

<p>åœ¨åˆšå¼€å§‹ç ”è¯»OBçš„ä»£ç æ—¶ï¼ŒOBç®€æ´çš„ä»£ç é£æ ¼è®©äººå°è±¡æ·±åˆ»ã€‚ä¸€èˆ¬è€Œè¨€ï¼ŒOBçš„å‡½æ•°è¿”å›å€¼ä¸æ˜¯å‡½æ•°çš„å¤„ç†ç»“æœï¼Œè€Œæ˜¯å‡½æ•°çš„æ‰§è¡ŒçŠ¶æ€ã€‚ä¸ä¹‹ç›¸å¯¹çš„ï¼Œå‡½æ•°çš„å¤„ç†ç»“æœä¼šé€šè¿‡ä¿®æ”¹å¼•ç”¨å‚æ•°çš„æ–¹å¼å‘ä¸Šä¼ é€’ã€‚å› æ­¤ï¼Œé€šè¿‡åˆ†ææ¯ä¸ªå‡½æ•°çš„è¿”å›å€¼ï¼Œå¯ä»¥ç®€å•å¾—çŸ¥è¿™ä¸ªå‡½æ•°çš„æ‰§è¡Œæµç¨‹ã€‚æ‰€ä»¥ï¼Œåœ¨OBçš„ä»£ç ä¸­ç»å¸¸èƒ½çœ‹åˆ°ç±»ä¼¼çš„ä»£ç ï¼š</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">if</span> <span class="p">(</span><span class="n">OB_FAIL</span><span class="p">(</span><span class="n">func_1</span><span class="p">)){</span>
     <span class="n">logging</span>
 <span class="p">}</span> <span class="k">else</span> <span class="p">(</span><span class="n">OB_FAIL</span><span class="p">(</span><span class="n">func_2</span><span class="p">)){</span>
     <span class="n">logging</span>
 <span class="p">}</span> <span class="k">else</span> <span class="p">(</span><span class="n">OB_SUCC</span><span class="p">(</span><span class="n">func_3</span><span class="p">)){</span>
     <span class="n">logging</span>
 <span class="p">}</span>
</code></pre></div></div>
<p>è¿™æ ·çš„ä»£ç å®é™…ä¸Šç›¸å½“äºé¡ºåºæ‰§è¡Œfunc_1ã€func_2ã€func_3ï¼Œå¹¶åœ¨å‡½æ•°æ‰§è¡Œå¤±è´¥/æˆåŠŸçš„æ—¶å€™è¾“å‡ºæ—¥å¿—ä¿¡æ¯ï¼Œä¸ç»§ç»­æ‰§è¡Œå‰©ä¸‹çš„å‡½æ•°ã€‚ä¸ºäº†åç»­å™è¿°çš„ç®€æ´ï¼Œå¯¹äºç±»ä¼¼çš„ä»£ç ï¼Œæˆ‘ä»¬å°†çœç•¥å‡½æ•°æ‰§è¡Œå¤±è´¥çš„å¼‚å¸¸å¤„ç†ã€‚</p>

<h2 id="æŸ¥è¯¢æ ‘çš„ç”Ÿæˆä»¥index-nested-loop-joinä¸ºä¾‹">æŸ¥è¯¢æ ‘çš„ç”Ÿæˆï¼šä»¥Index Nested Loop Joinä¸ºä¾‹</h2>

<p>åœ¨ç”Ÿæˆç‰©ç†çš„æŸ¥è¯¢æ ‘ä¹‹å‰ï¼ŒOBä¼šå…ˆç”Ÿæˆé€»è¾‘çš„æŸ¥è¯¢è®¡åˆ’ï¼Œç„¶åæ ¹æ®è¿™ä¸ªé€»è¾‘çš„æŸ¥è¯¢è®¡åˆ’ç¡®å®šå®é™…æ‰§è¡Œçš„ç‰©ç†è®¡åˆ’ã€‚åœ¨NLJä¸­ï¼Œæœ€é‡è¦çš„å°±æ˜¯joinç®—å­çš„ç”Ÿæˆï¼Œæ‰€ä»¥æˆ‘ä»¬ä»¥joinç®—å­çš„ç”Ÿæˆä¸ºä¾‹ä»‹ç»è¿™ä¸€éƒ¨åˆ†ã€‚</p>

<p>joinç®—å­çš„ç”Ÿæˆä¸»è¦ä¾èµ–äº<code class="language-plaintext highlighter-rouge">ObStaticEngineCG::generate_join_spec(ObLogJoin&amp; op, ObJoinSpec&amp; spec)</code>å‡½æ•°ã€‚è¿™ä¸€å‡½æ•°æ¥æ”¶ä¸¤ä¸ªå¼•ç”¨å‚æ•°opå’Œspecï¼Œopæ˜¯joinå¯¹åº”çš„é€»è¾‘è®¡åˆ’ï¼Œå½“æœ‰å¤šä¸ªjoinæ¡ä»¶æ—¶ï¼Œopè¯¦ç»†è®°å½•ç¬¬ä¸€ä¸ªjoinæ¡ä»¶ï¼Œå¹¶å°†å…¶ä»–çš„joinæ¡ä»¶å­˜å‚¨åœ¨<code class="language-plaintext highlighter-rouge">other_join_conditions</code>é‡Œï¼›specæ˜¯ç”Ÿæˆçš„ç‰©ç†æ‰§è¡Œè®¡åˆ’ã€‚<code class="language-plaintext highlighter-rouge">generate_join_spec()</code>åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ã€‚åœ¨ç¬¬ä¸€éƒ¨åˆ†ï¼Œå®ƒä¼šå¤„ç†é¦–è¦çš„joinæ¡ä»¶ï¼Œåˆ¤æ–­é€»è¾‘è®¡åˆ’ä¸­é¦–è¦çš„joinæ¡ä»¶çš„joinç±»å‹ï¼Œæ ¹æ®è¿™ä¸ªç±»å‹é€‰æ‹©ç”Ÿæˆå¯¹åº”çš„ç‰©ç†è®¡åˆ’ã€‚åœ¨ç¬¬äºŒéƒ¨åˆ†ï¼Œå®ƒéå†<code class="language-plaintext highlighter-rouge">other_join_conditions</code>ï¼Œé€ä¸ªè°ƒç”¨æ¥å£å‡½æ•°ç”Ÿæˆç‰©ç†æ‰§è¡Œè®¡åˆ’ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼ŒOBèƒ½å¤Ÿè‡ªç„¶åœ°å®ç°å¯¹é€»è¾‘è®¡åˆ’çš„é€’å½’å±•å¼€ï¼Œä»è€Œæ„å»ºå‡ºå¯¹åº”çš„ç‰©ç†æ‰§è¡Œæ ‘ã€‚æˆ‘ä»¬å¯¹è¿™ä¸€å‡½æ•°è¿›è¡Œäº†æ•´ç†å’Œæå–ï¼ŒæŠ½è±¡å‡ºå…¶ä¸­çš„é€»è¾‘å¦‚ä¸‹ï¼š</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="kt">int</span> <span class="n">ObStaticEngineCG</span><span class="o">::</span><span class="n">generate_join_spec</span><span class="p">(</span><span class="n">ObLogJoin</span><span class="o">&amp;</span> <span class="n">op</span><span class="p">,</span> <span class="n">ObJoinSpec</span><span class="o">&amp;</span> <span class="n">spec</span><span class="p">)</span>
 <span class="p">{</span>
   <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">OB_SUCCESS</span><span class="p">;</span>
   <span class="kt">bool</span> <span class="n">is_late_mat</span> <span class="o">=</span> <span class="p">(</span><span class="n">phy_plan_</span><span class="o">-&gt;</span><span class="n">get_is_late_materialized</span><span class="p">()</span> <span class="o">||</span> <span class="n">op</span><span class="p">.</span><span class="n">is_late_mat</span><span class="p">());</span>
   <span class="n">phy_plan_</span><span class="o">-&gt;</span><span class="n">set_is_late_materialized</span><span class="p">(</span><span class="n">is_late_mat</span><span class="p">);</span>

   <span class="n">spec</span><span class="p">.</span><span class="n">join_type_</span> <span class="o">=</span> <span class="n">op</span><span class="p">.</span><span class="n">get_join_type</span><span class="p">();</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">MERGE_JOIN</span> <span class="o">==</span> <span class="n">op</span><span class="p">.</span><span class="n">get_join_algo</span><span class="p">())</span> <span class="p">{</span>
       <span class="c1">// æŸ¥è¯¢è®¡åˆ’æ˜¯merge joinæ—¶çš„å¤„ç†ï¼Œæš‚ç•¥</span>
   <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">NESTED_LOOP_JOIN</span> <span class="o">==</span> <span class="n">op</span><span class="p">.</span><span class="n">get_join_algo</span><span class="p">())</span> <span class="p">{</span>  <span class="c1">// nested loop join</span>
     <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">op</span><span class="p">.</span><span class="n">get_equal_join_conditions</span><span class="p">().</span><span class="n">count</span><span class="p">())</span> <span class="p">{</span>
     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
       <span class="n">ObBasicNestedLoopJoinSpec</span><span class="o">&amp;</span> <span class="n">nlj_spec</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">ObBasicNestedLoopJoinSpec</span><span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">spec</span><span class="p">);</span>
       <span class="n">nlj_spec</span><span class="p">.</span><span class="n">enable_gi_partition_pruning_</span> <span class="o">=</span> <span class="n">op</span><span class="p">.</span><span class="n">is_enable_gi_partition_pruning</span><span class="p">();</span>
       <span class="k">const</span> <span class="n">ObIArray</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="kt">int64_t</span><span class="p">,</span> <span class="n">ObRawExpr</span><span class="o">*&gt;&gt;&amp;</span> <span class="n">nl_params</span> <span class="o">=</span> <span class="n">op</span><span class="p">.</span><span class="n">get_nl_params</span><span class="p">();</span>
       <span class="k">if</span> <span class="p">(</span><span class="n">nlj_spec</span><span class="p">.</span><span class="n">enable_gi_partition_pruning_</span> <span class="o">&amp;&amp;</span>
           <span class="n">OB_FAIL</span><span class="p">(</span><span class="n">do_gi_partition_pruning</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">nlj_spec</span><span class="p">)))</span> <span class="p">{</span> <span class="c1">// å¦‚æœå¯ä»¥çš„è¯ï¼Œè¿›è¡Œåˆ†åŒºè£å‰ª</span>
       <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">OB_FAIL</span><span class="p">(</span><span class="n">nlj_spec</span><span class="p">.</span><span class="n">init_param_count</span><span class="p">(</span><span class="n">nl_params</span><span class="p">.</span><span class="n">count</span><span class="p">())))</span> <span class="p">{</span> <span class="c1">// åˆå§‹åŒ–joinçš„å‚æ•°æ•°é‡</span>
       <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="n">ObIArray</span><span class="o">&lt;</span><span class="n">ObRawExpr</span><span class="o">*&gt;&amp;</span> <span class="n">exec_param_exprs</span> <span class="o">=</span> <span class="n">op</span><span class="p">.</span><span class="n">get_stmt</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">get_exec_param_ref_exprs</span><span class="p">();</span>
         <span class="n">ARRAY_FOREACH</span><span class="p">(</span><span class="n">nl_params</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span><span class="c1">// éå†æ¯ä¸ªå‚æ•°</span>
         <span class="p">{</span>
             <span class="c1">// æ ¹æ®å‚æ•°ç”Ÿæˆç‰©ç†æ‰§è¡Œç®—å­ï¼Œå…·ä½“å†…å®¹ç•¥</span>
         <span class="p">}</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">OB_SUCC</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">PHY_NESTED_LOOP_JOIN</span> <span class="o">==</span> <span class="n">spec</span><span class="p">.</span><span class="n">type_</span><span class="p">)</span> <span class="p">{</span>
           <span class="c1">// åˆ¤æ–­èƒ½å¦ä½¿ç”¨batch nljï¼Œå¦‚æœå¯ä»¥å°±æ›´æ–°flag</span>
           <span class="kt">bool</span> <span class="n">use_batch_nlj</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
           <span class="n">ObNestedLoopJoinSpec</span><span class="o">&amp;</span> <span class="n">nlj</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">ObNestedLoopJoinSpec</span><span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">spec</span><span class="p">);</span>
           <span class="k">if</span> <span class="p">(</span><span class="n">OB_FAIL</span><span class="p">(</span><span class="n">op</span><span class="p">.</span><span class="n">can_use_batch_nlj</span><span class="p">(</span><span class="n">use_batch_nlj</span><span class="p">)))</span> <span class="p">{</span><span class="c1">// åˆ¤æ–­èƒ½ä¸èƒ½ç”¨ï¼Œå½“joinæ¡ä»¶æœ‰å¤æ•°å­—æ®µç»„æˆæ—¶ä¸ä½¿ç”¨batch</span>
           <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">use_batch_nlj</span><span class="p">)</span> <span class="p">{</span>
             <span class="n">nlj</span><span class="p">.</span><span class="n">use_group_</span> <span class="o">=</span> <span class="n">use_batch_nlj</span><span class="p">;</span>
             <span class="k">if</span> <span class="p">(</span><span class="n">OB_ISNULL</span><span class="p">(</span><span class="n">nlj</span><span class="p">.</span><span class="n">get_right</span><span class="p">())</span> <span class="o">||</span> <span class="n">PHY_TABLE_SCAN</span> <span class="o">!=</span> <span class="n">nlj</span><span class="p">.</span><span class="n">get_right</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">type_</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// åªæœ‰table scançš„æ—¶å€™æ‰ä¼šé€‰æ‹©batch nlj</span>
             <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
               <span class="k">const</span> <span class="n">ObTableScanSpec</span><span class="o">*</span> <span class="n">right_tsc</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">ObTableScanSpec</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">nlj</span><span class="p">.</span><span class="n">get_right</span><span class="p">());</span>
               <span class="k">const_cast</span><span class="o">&lt;</span><span class="n">ObTableScanSpec</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">right_tsc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">batch_scan_flag_</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
             <span class="p">}</span>
           <span class="p">}</span>
         <span class="p">}</span>
       <span class="p">}</span>
     <span class="p">}</span>
   <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">HASH_JOIN</span> <span class="o">==</span> <span class="n">op</span><span class="p">.</span><span class="n">get_join_algo</span><span class="p">())</span> <span class="p">{</span>
     <span class="c1">// æŸ¥è¯¢è®¡åˆ’æ˜¯hash joinæ—¶çš„å¤„ç†ï¼Œæš‚ç•¥</span>
   <span class="p">}</span>
   <span class="k">const</span> <span class="n">common</span><span class="o">::</span><span class="n">ObIArray</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="kt">int64_t</span><span class="p">,</span> <span class="n">ObRawExpr</span><span class="o">*&gt;&gt;&amp;</span> <span class="n">exec_params</span> <span class="o">=</span> <span class="n">op</span><span class="p">.</span><span class="n">get_exec_params</span><span class="p">();</span>
 
   <span class="c1">// 2. add other join conditions</span>
   <span class="k">const</span> <span class="n">ObIArray</span><span class="o">&lt;</span><span class="n">ObRawExpr</span><span class="o">*&gt;&amp;</span> <span class="n">other_join_conds</span> <span class="o">=</span> <span class="n">op</span><span class="p">.</span><span class="n">get_other_join_conditions</span><span class="p">();</span>
   <span class="c1">// åˆå§‹åŒ–other condition</span>
   <span class="n">OZ</span><span class="p">(</span><span class="n">spec</span><span class="p">.</span><span class="n">other_join_conds_</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="n">other_join_conds</span><span class="p">.</span><span class="n">count</span><span class="p">()));</span>
 
   <span class="n">ARRAY_FOREACH</span><span class="p">(</span><span class="n">other_join_conds</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="c1">// éå†å‰©ä¸‹çš„æ¡ä»¶</span>
   <span class="p">{</span>
     <span class="c1">// é€ä¸ªç”Ÿæˆå‰©ä¸‹æ¡ä»¶çš„ç‰©ç†ç®—å­</span>
   <span class="p">}</span>  <span class="c1">// end for</span>
 
   <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
 <span class="p">}</span>
</code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">generate_join_spec()</code> å¯¹äºNLJæœ€ä¸ºç‰¹åˆ«çš„å¤„ç†å°±æ˜¯åˆ¤æ–­èƒ½å¦ä½¿ç”¨batch NLJï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬æ‰€å…³æ³¨çš„ç¬¬ä¸€ä¸ªä¼˜åŒ–ç‚¹ã€‚é€šè¿‡debugæˆ‘ä»¬çŸ¥é“ï¼Œç”±äºæ¯”èµ›ä¸­çš„æŸ¥è¯¢è¯­å¥çš„joinæ¡ä»¶å«æœ‰ä¸¤ä¸ªå­—æ®µï¼Œè¿™ä¸ªå‡½æ•°ä¸ä¼šé€‰æ‹©ä½¿ç”¨batch NLJã€‚å› æ­¤ï¼Œæˆ‘ä»¬é€šè¿‡æ‰©å±•OBå¯¹batch NLJçš„æ”¯æŒå’Œä¿®æ”¹åˆ¤å®šæ¡ä»¶ï¼Œä½¿å¾—<code class="language-plaintext highlighter-rouge">generate_join_spec()</code>èƒ½å°†æ¯”èµ›ä¸­çš„æŸ¥è¯¢è½¬åŒ–ä¸ºbatch NLJçš„ç‰©ç†æ‰§è¡Œè®¡åˆ’ã€‚</p>

<h2 id="æŸ¥è¯¢æ‰§è¡Œä»¥index-nested-loop-joinä¸ºä¾‹">æŸ¥è¯¢æ‰§è¡Œï¼šä»¥Index Nested Loop Joinä¸ºä¾‹</h2>

<p>å½“é€»è¾‘æ‰§è¡Œè®¡åˆ’é‡Œçš„NLJç»è¿‡<code class="language-plaintext highlighter-rouge">generate_join_spec</code>è½¬æ¢ä¸ºç‰©ç†çš„æ‰§è¡Œç®—å­ä¹‹åï¼ŒOBå°±ä¼šé€šè¿‡ç«å±±æ¨¡å‹é€å±‚æ‰§è¡Œç‰©ç†ç®—å­ï¼Œå¹¶ä¸€æ¬¡å‘ä¸Šå±‚ç®—å­å‘ˆé€’ä¸€è¡Œæ•°æ®ã€‚å¯¹äºNLJè€Œè¨€ï¼Œè¿™éƒ¨åˆ†åŠŸèƒ½ä¸»è¦ç”±<code class="language-plaintext highlighter-rouge">ObNestedLoopJoinOp::inner_get_next_row()</code>å®ç°ã€‚è¿™ä¸€å‡½æ•°å¹¶ä¸éœ€è¦è¿”å›å€¼ï¼Œæ˜¯å› ä¸ºå®ƒä¼šç›´æ¥é€šè¿‡ä¿®æ”¹ä¸Šä¸‹æ–‡ä¿¡æ¯çš„æ–¹å¼ä¿å­˜ä¸€æ¬¡è°ƒç”¨æ‰€è·å–çš„æ•°æ®ã€‚</p>

<p>ä½œä¸ºä¸€ä¸ªjoinç®—å­ï¼Œ<code class="language-plaintext highlighter-rouge">ObNestedLoopJoinOp</code>å¾ˆè‡ªç„¶åœ°å«æœ‰ä¸¤ä¸ªå­èŠ‚ç‚¹ã€‚å¯¹äºæ¯”èµ›ä¸­çš„æŸ¥è¯¢è¯­å¥ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“çŸ¥é“è¿™ä¸¤ä¸ªå­èŠ‚ç‚¹éƒ½æ˜¯table scanç®—å­ã€‚ä¸”ä¸è®ºå·¦å³èŠ‚ç‚¹çš„åŒºåˆ«ï¼Œæ¯æ¬¡è°ƒç”¨joinç®—å­æ—¶éœ€è¦ä»å·¦å³èŠ‚ç‚¹åˆ†åˆ«è·å–ä¸€è¡Œæ•°æ®å¹¶è¿æ¥ã€‚ä½†åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­å¯èƒ½å‡ºç°å¾ˆå¤šç§æƒ…å†µï¼Œæ¯”å¦‚å³èŠ‚ç‚¹è·å–çš„æ•°æ®ä¸å·¦èŠ‚ç‚¹è·å–çš„æ•°æ®ä¸åŒ¹é…ï¼Œéå†å®Œå³èŠ‚ç‚¹éƒ½æ— æ³•ä¸å·¦èŠ‚ç‚¹å½“å‰çš„æ•°æ®åŒ¹é…ç­‰ç­‰ã€‚å› æ­¤ï¼Œä¸ºäº†æ›´å¥½åœ°å®ç°è¿™éƒ¨åˆ†é€»è¾‘ï¼ŒOBåœ¨å‡½æ•°ä¸­å®ç°äº†ä¸€ä¸ªå°å‹çš„çŠ¶æ€æœºï¼Œæ ¹æ®å½“å‰çŠ¶æ€é€‰æ‹©åç»­éœ€è¦æ‰§è¡Œçš„å‡½æ•°ã€‚ç¤ºæ„å›¾å¦‚ä¸‹ï¼š</p>

<pre><code class="language-flow">start=&gt;start: å¼€å§‹inner_get_next_row
end=&gt;end: è¿”å›ç»“æœ
left_op=&gt;operation: read_left_operate()
left_going=&gt;operation: read_left_func_going()
left_end=&gt;operation: read_left_func_end()
right_op=&gt;operation: read_right_operate()
right_going=&gt;operation: read_right_func_going()
right_end=&gt;operation: read_right_func_end()
iter_end1=&gt;condition: å·¦èŠ‚ç‚¹å­˜åœ¨ä¸‹ä¸€è¡Œæ•°æ®
iter_end2=&gt;condition: å³èŠ‚ç‚¹å­˜åœ¨ä¸‹ä¸€è¡Œæ•°æ®
output_product=&gt;condition: è¿æ¥æˆåŠŸ

start-&gt;left_op-&gt;iter_end1
iter_end1(yes)-&gt;left_going-&gt;right_op-&gt;iter_end2
iter_end1(no)-&gt;left_end-&gt;end
iter_end2(yes)-&gt;right_going-&gt;output_product
iter_end2(no)-&gt;right_end-&gt;output_product
output_product(yes)-&gt;end
output_product(no)-&gt;left_op
</code></pre>
<p>å…¶ä»£ç æŠ½è±¡å¦‚ä¸‹ï¼š</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="n">ObNestedLoopJoinOp</span><span class="o">::</span><span class="n">inner_get_next_row</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">OB_SUCCESS</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">OB_UNLIKELY</span><span class="p">(</span><span class="n">LEFT_SEMI_JOIN</span> <span class="o">==</span> <span class="n">MY_SPEC</span><span class="p">.</span><span class="n">join_type_</span> <span class="o">||</span> <span class="n">LEFT_ANTI_JOIN</span> <span class="o">==</span> <span class="n">MY_SPEC</span><span class="p">.</span><span class="n">join_type_</span><span class="p">))</span> <span class="p">{</span>
   	<span class="c1">// å¤„ç†åŠè¿æ¥ï¼Œå…·ä½“å†…å®¹ç•¥</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">state_operation_func_type</span> <span class="n">state_operation</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">state_function_func_type</span> <span class="n">state_function</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">func</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">output_row_produced_</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">OB_SUCC</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">output_row_produced_</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">state_operation</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">ObNestedLoopJoinOp</span><span class="o">::</span><span class="n">state_operation_func_</span><span class="p">[</span><span class="n">state_</span><span class="p">];</span><span class="c1">// state_å–å€¼ä¸ºleft rightï¼Œè¡¨ç¤ºå½“å‰æ‰§è¡Œå·¦èŠ‚ç‚¹è¿˜æ˜¯å³èŠ‚ç‚¹çš„ä»»åŠ¡</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">OB_ITER_END</span> <span class="o">==</span> <span class="p">(</span><span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="o">-&gt;*</span><span class="n">state_operation</span><span class="p">)()))</span> <span class="p">{</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">FT_ITER_END</span><span class="p">;</span><span class="c1">// funcçš„å–å€¼ä¸ºendã€goingï¼Œå¯¹åº”å–æµç¨‹å›¾ä¸­endæˆ–æ˜¯goingåç¼€çš„å‡½æ•°</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">OB_SUCCESS</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">OB_FAIL</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span> <span class="p">{</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">FT_ITER_GOING</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">OB_SUCC</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">state_function</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">ObNestedLoopJoinOp</span><span class="o">::</span><span class="n">state_function_func_</span><span class="p">[</span><span class="n">state_</span><span class="p">][</span><span class="n">func</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">OB_FAIL</span><span class="p">((</span><span class="k">this</span><span class="o">-&gt;*</span><span class="n">state_function</span><span class="p">)())</span> <span class="o">&amp;&amp;</span> <span class="n">OB_ITER_END</span> <span class="o">!=</span> <span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>  <span class="c1">// while end</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<p>å…¶ä¸­ä¸€å…±åŒ…å«6ä¸ªå‡½æ•°ï¼Œåˆ†åˆ«æ˜¯å·¦å³èŠ‚ç‚¹çš„<code class="language-plaintext highlighter-rouge">operate(),func_going(),func_end()</code>å‡½æ•°ã€‚å…¶ä¸­ï¼Œ<code class="language-plaintext highlighter-rouge">operate()</code>å‡½æ•°è´Ÿè´£ä»å¯¹åº”å­èŠ‚ç‚¹è·å–ä¸€è¡Œæ•°æ®ï¼›<code class="language-plaintext highlighter-rouge">func_going()</code>å‡½æ•°è´Ÿè´£åˆ¤æ–­æ˜¯å¦éœ€è¦åˆ‡æ¢ä¸ºå¦ä¸€ä¸ªèŠ‚ç‚¹çš„å‡½æ•°ï¼Œå¹¶åšé¢„å¤„ç†ï¼Œå¦‚<code class="language-plaintext highlighter-rouge">left_func_going()</code>ä¼šæ ¹æ®å·¦èŠ‚ç‚¹è·å–çš„æ•°æ®ï¼Œå‡†å¤‡æ‰«æå³èŠ‚ç‚¹æ‰€éœ€è¦çš„å‚æ•°ï¼ˆå€¼å¾—ä¸€æçš„æ˜¯ï¼Œå› ä¸ºå®é™…ä¸Šè¿™ä¸ªå‡½æ•°ä¼šæ·±å…¥åº•å±‚æ›´æ–°å³èŠ‚ç‚¹çš„è¿­ä»£å™¨ï¼Œæ‰€ä»¥å¼€é”€æ˜¯å¾ˆå¤§çš„ï¼‰ï¼Œ<code class="language-plaintext highlighter-rouge">right_func_going()</code>è´Ÿè´£åˆ¤æ–­æ˜¯å¦è¿æ¥æˆåŠŸï¼›<code class="language-plaintext highlighter-rouge">func_end()</code>åˆ¤æ–­æ˜¯å¦å¾—åˆ°äº†éœ€è¦çš„ç»“æœï¼Œå¹¶ä¿®æ”¹<code class="language-plaintext highlighter-rouge">inner_get_next_row()</code>çš„è¿”å›å€¼ã€‚</p>

<p>åœ¨è¿™6ä¸ªå‡½æ•°ä¸­ï¼Œ<code class="language-plaintext highlighter-rouge">func_going()</code>å’Œ<code class="language-plaintext highlighter-rouge">func_end()</code>çš„å‡½æ•°é€»è¾‘éƒ½æ¯”è¾ƒç®€å•ï¼Œæˆ‘ä»¬ä¸å†åœ¨è¿™é‡Œèµ˜è¿°ã€‚ä»¥ä¸‹ä¸»è¦ä»‹ç»å·¦å³èŠ‚ç‚¹çš„<code class="language-plaintext highlighter-rouge">operate()</code>å‡½æ•°ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬ä¼˜åŒ–batch_nljæ‰€ä¸»è¦å…³å¿ƒçš„å‡½æ•°ã€‚</p>

<h3 id="joinçš„å·¦å­èŠ‚ç‚¹å®ç°batch-or-not-batch">Joinçš„å·¦å­èŠ‚ç‚¹å®ç°ï¼šbatch, or not batch</h3>

<p>æ ¹æ®åœ¨æ„å»ºç‰©ç†æ‰§è¡Œæ ‘æ—¶çš„åˆ¤æ–­ï¼Œleft_operate()å­˜åœ¨ä¸¤ç§æ‰§è¡Œé€»è¾‘ï¼Œåˆ†åˆ«å¯¹åº”ä¸ä½¿ç”¨batch NLJå’Œä½¿ç”¨batch NLJã€‚å½“ä¸ä½¿ç”¨batch nljæ—¶ï¼Œå‡½æ•°ç›´æ¥è°ƒç”¨å¯¹åº”ç®—å­çš„next_row()æ–¹æ³•ã€‚è¿™ä¸€æ–¹æ³•ä¼šä¸æ–­å‘ä¸‹è·å–ä¸€è¡Œæ•°æ®ï¼Œå…·ä½“çš„è°ƒç”¨æ ˆå¦‚ä¸‹ï¼š</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="n">oceanbase</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">ObmultipleScanMergeImpI</span><span class="o">::</span><span class="n">supply_consume</span><span class="p">()</span>
 <span class="n">oceanbase</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">ObmultipleScanMergeImpI</span><span class="o">::</span><span class="n">inner_get_next_row</span><span class="p">()</span>
 <span class="n">oceanbase</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">ObmultipleScanMerge</span><span class="o">::</span><span class="n">inner_get_next_row</span><span class="p">()</span>
 <span class="n">oceanbase</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">ObmultipleMerge</span><span class="o">::</span><span class="n">get_next_row</span><span class="p">()</span>
 <span class="n">oceanbase</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">ObTableScanStoreRowIterator</span><span class="o">::</span><span class="n">get_next_row</span><span class="p">()</span>
 <span class="n">oceanbase</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">ObTableScanRangeArrayRowIterator</span><span class="o">::</span><span class="n">get_next_row</span><span class="p">()</span>
 <span class="n">oceanbase</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">ObTableScanIterator</span><span class="o">::</span><span class="n">get_next_row</span><span class="p">()</span>
 <span class="n">oceanbase</span><span class="o">::</span><span class="n">sql</span><span class="o">::</span><span class="n">ObTableScanOp</span><span class="o">::</span><span class="n">get_next_row_with_mode</span><span class="p">()</span>
 <span class="n">oceanbase</span><span class="o">::</span><span class="n">sql</span><span class="o">::</span><span class="n">ObTableScanOp</span><span class="o">::</span><span class="n">inner_get_next_row</span><span class="p">()</span>
 <span class="n">oceanbase</span><span class="o">::</span><span class="n">sql</span><span class="o">::</span><span class="n">ObOperator</span><span class="o">::</span><span class="n">get_next_row</span><span class="p">()</span>
 <span class="n">oceanbase</span><span class="o">::</span><span class="n">sql</span><span class="o">::</span><span class="n">ObJoinOp</span><span class="o">::</span><span class="n">get_next_left_row</span><span class="p">()</span>
 <span class="n">oceanbase</span><span class="o">::</span><span class="n">sql</span><span class="o">::</span><span class="n">ObBasicNestedLoopJoin</span><span class="o">::</span><span class="n">get_next_left_row</span><span class="p">()</span>
</code></pre></div></div>
<p>é€šè¿‡æ£€æŸ¥ä»£ç ï¼Œæˆ‘ä»¬å‘ç°æ¯å±‚è°ƒç”¨çš„é€»è¾‘éƒ½éå¸¸æ¸…æ™°ï¼Œä¸»è¦æ˜¯è°ƒç”¨ä¸‹å±‚æ¥å£ä»¥åŠå¼‚å¸¸å¤„ç†ï¼Œå› æ­¤ä¸å†èµ˜è¿°ã€‚æˆ‘ä»¬ä¸»è¦è®¨è®ºä½¿ç”¨batch NLJæ—¶çš„æ‰§è¡Œé€»è¾‘ã€‚</p>

<p>å½“ä½¿ç”¨batch NLJæ—¶ï¼Œjoinç®—å­ä¼šå…ˆå–å‡ºå·¦èŠ‚ç‚¹ä¸­çš„ä¸€æ‰¹æ•°æ®ï¼Œç„¶åå†é€ä¸ªä¸å³èŠ‚ç‚¹è¿›è¡ŒåŒ¹é…ã€‚è¿™ç§æ–¹å¼å¯ä»¥æ›´å¥½åœ°åˆ©ç”¨æ•°æ®çš„å±€éƒ¨æ€§ï¼Œæé«˜å¯¹ç£ç›˜æ•°æ®çš„è®¿é—®æ•ˆç‡ã€‚ä¸ºäº†å®ç°æ‰¹é‡è·å–æ•°æ®ï¼ŒåŒæ—¶åˆä¸æ”¹å˜ç¨‹åºå…¶ä»–éƒ¨åˆ†çš„é€»è¾‘ï¼Œä½¿ç”¨batch NLJæ—¶éœ€è¦åœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶è¿ç»­è°ƒç”¨å¤šæ¬¡ç®—å­çš„<code class="language-plaintext highlighter-rouge">next_row()</code>æ–¹æ³•å¹¶å­˜å‚¨å¯¹åº”çš„æ•°æ®ï¼Œåœ¨åç»­è°ƒç”¨æ—¶ç›´æ¥ä»å­˜å‚¨çš„æ•°æ®ä¸­å¯¼å‡ºå¯¹åº”æ•°æ®ã€‚å…¶ä»£ç æŠ½è±¡å¦‚ä¸‹ï¼š</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="kt">int</span> <span class="n">ObNestedLoopJoinOp</span><span class="o">::</span><span class="n">group_read_left_operate</span><span class="p">()</span>
 <span class="p">{</span>
   <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">OB_SUCCESS</span><span class="p">;</span>
   <span class="n">ObTableScanOp</span><span class="o">*</span> <span class="n">right_tsc</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">ObTableScanOp</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">right_</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">left_store_iter_</span><span class="p">.</span><span class="n">is_valid</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">left_store_iter_</span><span class="p">.</span><span class="n">has_next</span><span class="p">())</span> <span class="p">{</span>
     <span class="c1">// å½“å½“å‰è¿˜æœ‰å­˜å‚¨æ•°æ®æ—¶ï¼Œç›´æ¥è·å–å­˜å‚¨æ•°æ®ï¼Œå…·ä½“å†…å®¹ç•¥</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// æ²¡æœ‰å­˜å‚¨æ•°æ®æ—¶ï¼Œæ‰¹é‡è·å–æ•°æ®</span>
     <span class="k">if</span> <span class="p">(</span><span class="n">OB_FAIL</span><span class="p">(</span><span class="n">right_tsc</span><span class="o">-&gt;</span><span class="n">group_rescan_init</span><span class="p">(</span><span class="n">MY_SPEC</span><span class="p">.</span><span class="n">batch_size_</span><span class="p">)))</span> <span class="p">{</span>
     <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_left_end_</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// åˆ¤æ–­å·¦èŠ‚ç‚¹æ˜¯å¦å·²ç»å–å®Œ</span>
     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
       <span class="k">if</span> <span class="p">(</span><span class="n">OB_ISNULL</span><span class="p">(</span><span class="n">mem_context_</span><span class="p">))</span> <span class="p">{</span>
           <span class="c1">// åˆå§‹åŒ–å­˜å‚¨æ•°æ®çš„ç»“æ„ï¼Œå…·ä½“å†…å®¹ç•¥</span>
       <span class="p">}</span>
 
       <span class="kt">bool</span> <span class="n">ignore_end</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
       <span class="k">if</span> <span class="p">(</span><span class="n">OB_SUCC</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span> <span class="p">{</span>
           <span class="c1">//åˆå§‹åŒ–æˆ–é‡ç½®è®¿é—®æ•°æ®å’Œå®ƒçš„è¿­ä»£å™¨left_store_å’Œleft_store_iter_ï¼Œå…·ä½“å†…å®¹ç•¥</span>
         <span class="p">}</span>
         <span class="n">save_last_row_</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
         <span class="k">while</span> <span class="p">(</span><span class="n">OB_SUCC</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">is_full</span><span class="p">())</span> <span class="p">{</span>
             <span class="c1">// æ‰¹é‡è·å–æ•°æ®</span>
           <span class="n">clear_evaluated_flag</span><span class="p">();</span> <span class="c1">// æ¸…ç†è®¿é—®å‚æ•°</span>
           <span class="k">if</span> <span class="p">(</span><span class="n">OB_FAIL</span><span class="p">(</span><span class="n">get_next_left_row</span><span class="p">()))</span> <span class="p">{</span> <span class="c1">// è·å–ä¸‹ä¸€è¡Œ</span>
             <span class="k">if</span> <span class="p">(</span><span class="n">OB_ITER_END</span> <span class="o">!=</span> <span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
             <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
               <span class="n">is_left_end_</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
             <span class="p">}</span>
           <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">OB_FAIL</span><span class="p">(</span><span class="n">left_store_</span><span class="p">.</span><span class="n">add_row</span><span class="p">(</span><span class="n">left_</span><span class="o">-&gt;</span><span class="n">get_spec</span><span class="p">().</span><span class="n">output_</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eval_ctx_</span><span class="p">)))</span> <span class="p">{</span><span class="c1">// å­˜å‚¨åˆ°å­˜å‚¨åˆ°å¯¹åº”çš„ç»“æ„left_store_ä¸­</span>
           <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">OB_FAIL</span><span class="p">(</span><span class="n">prepare_rescan_params</span><span class="p">(</span><span class="nb">true</span> <span class="cm">/*is_group*/</span><span class="p">)))</span> <span class="p">{</span>
           <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">OB_FAIL</span><span class="p">(</span><span class="n">deep_copy_dynamic_obj</span><span class="p">()))</span> <span class="p">{</span>
           <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">OB_FAIL</span><span class="p">(</span><span class="n">right_tsc</span><span class="o">-&gt;</span><span class="n">group_add_query_range</span><span class="p">()))</span> <span class="p">{</span> <span class="c1">// å­˜å‚¨å¯¹åº”çš„å³èŠ‚ç‚¹è®¿é—®å‚æ•°</span>
           <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
             <span class="n">ignore_end</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
           <span class="p">}</span>
         <span class="p">}</span>
       <span class="p">}</span>
 
       <span class="k">if</span> <span class="p">(</span><span class="n">OB_SUCC</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ignore_end</span> <span class="o">&amp;&amp;</span> <span class="n">OB_ITER_END</span> <span class="o">==</span> <span class="n">ret</span><span class="p">))</span> <span class="p">{</span>
         <span class="c1">// æ›´æ–°è¿­ä»£å™¨left_store_iter_ï¼Œå¹¶æ›´æ–°å³èŠ‚ç‚¹çš„è®¿é—®å‚æ•°ï¼Œå…·ä½“å†…å®¹ç•¥</span>
       <span class="p">}</span>
     <span class="p">}</span>
   <span class="p">}</span>
 
   <span class="k">if</span> <span class="p">(</span><span class="n">OB_SUCC</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// ä»å­˜å‚¨ç»“æ„left_store_é‡Œæ‹¿ä¸€è¡Œæ•°æ®ï¼Œä½œä¸ºæœ¬æ¬¡è°ƒç”¨çš„è¿”å›ç»“æœ</span>
     <span class="k">if</span> <span class="p">(</span><span class="n">OB_FAIL</span><span class="p">(</span><span class="n">left_store_iter_</span><span class="p">.</span><span class="n">get_next_row</span><span class="p">(</span><span class="n">left_</span><span class="o">-&gt;</span><span class="n">get_spec</span><span class="p">().</span><span class="n">output_</span><span class="p">,</span> <span class="n">eval_ctx_</span><span class="p">)))</span> <span class="p">{</span>
     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
       <span class="n">left_row_joined_</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
     <span class="p">}</span>
   <span class="p">}</span>
   <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
 <span class="p">}</span>
</code></pre></div></div>
<p>å¯ä»¥æ³¨æ„åˆ°ï¼Œåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œ<code class="language-plaintext highlighter-rouge">group_read_left_operate()</code>ä¼šå­˜å‚¨æ¯ä¸€è¡Œæ•°æ®å¯¹åº”çš„å³èŠ‚ç‚¹è®¿é—®å‚æ•°ã€‚æ›´å…·ä½“æ¥è¯´ï¼Œæ˜¯è¿™ä¸€è¡Œæ•°æ®å¯¹åº”ç¬¬ä¸€ä¸ªjoinæ¡ä»¶å­—æ®µçš„å€¼ã€‚å› æ­¤ï¼Œå¦‚æœå­˜åœ¨å¤šäºä¸€ä¸ªjoinå­—æ®µï¼Œå‰©ä½™çš„å­—æ®µå€¼ä¸ä¼šè¢«å­˜å‚¨ï¼Œè¿™å¯¼è‡´ä½¿ç”¨batch NLJæ—¶æ— æ³•æ­£ç¡®æ ¹æ®joinæ¡ä»¶è¿‡æ»¤ç»“æœï¼Œè¿™ä¹Ÿæ˜¯OBåŸæœ¬åªé™åˆ¶åœ¨joinæ¡ä»¶å”¯ä¸€æ—¶ä½¿ç”¨batch NLJçš„åŸå› ã€‚ä¸ºäº†ä½¿ç”¨batch NLJï¼Œæˆ‘ä»¬å¯¹å­˜å‚¨ç»“æ„è¿›è¡Œæ‰©å±•ï¼Œä½¿å®ƒèƒ½å­˜å‚¨å‰©ä½™æ¡ä»¶å­—æ®µçš„å€¼ï¼Œä»è€Œä¿è¯å¯¹äºæ¯”èµ›çš„æŸ¥è¯¢è¯­å¥ä¹Ÿèƒ½æœ‰æ•ˆä¸”æ­£ç¡®ä½¿ç”¨batch NLJã€‚</p>

<h3 id="joinçš„å³èŠ‚ç‚¹å®ç°index-merge">J<strong>oinçš„å³èŠ‚ç‚¹å®ç°ï¼šindex merge</strong>
</h3>

<p>ä¸å·¦èŠ‚ç‚¹ç¨æœ‰ä¸åŒï¼Œå³èŠ‚ç‚¹å¹¶éæ˜¯ä¸€ä¸ªæ™®é€šçš„table scanï¼Œè€Œæ˜¯ä¸€ä¸ªå¸¦æœ‰indexçš„scanã€‚å› æ­¤ï¼Œåœ¨è¿™ä¸ªç®—å­æ‰«æç»“æœçš„æ—¶å€™ï¼Œä¼šé¦–å…ˆåœ¨ç´¢å¼•è¡¨ä¸­è¿›è¡Œæœç´¢å’Œå®šä½ï¼Œç„¶ååŸºäºå®šä½çš„ç»“æœç›´æ¥æ„é€ æ•°æ®è¡¨ä¸­çš„è¿­ä»£å™¨ï¼Œä»è€ŒåŠ é€Ÿæ•°æ®çš„è·å–ã€‚è¿™ä¸€æµç¨‹åœ¨ä»£ç ä¸Šçš„ä½“ç°ä¾¿æ˜¯è¿™ä¸ªç®—å­åŒæ—¶ç»´æŠ¤äº†ä¸¤å¼ è¡¨çš„è¿­ä»£å™¨ï¼Œåˆ†åˆ«æ˜¯æ•°æ®è¡¨çš„<code class="language-plaintext highlighter-rouge">main_iter_</code>å’Œç´¢å¼•è¡¨çš„<code class="language-plaintext highlighter-rouge">index_iter_</code>ã€‚å…¶ä»£ç æŠ½è±¡å¦‚ä¸‹ï¼š</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="kt">int</span> <span class="n">ObIndexMerge</span><span class="o">::</span><span class="n">get_next_row</span><span class="p">(</span><span class="n">ObStoreRow</span><span class="o">*&amp;</span> <span class="n">row</span><span class="p">)</span>
 <span class="p">{</span>
   <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">OB_SUCCESS</span><span class="p">;</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">OB_UNLIKELY</span><span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">index_iter_</span><span class="p">)</span> <span class="o">||</span> <span class="n">OB_UNLIKELY</span><span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">access_ctx_</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// æ²¡æœ‰åˆå§‹åŒ–</span>
   <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">access_ctx_</span><span class="o">-&gt;</span><span class="n">is_end</span><span class="p">())</span> <span class="p">{</span> <span class="c1">// å·²ç»æ‰«æå®Œäº†</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
     <span class="k">while</span> <span class="p">(</span><span class="n">OB_SUCC</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span> <span class="p">{</span>
       <span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">!=</span> <span class="n">main_iter_</span> <span class="o">&amp;&amp;</span> <span class="n">OB_SUCC</span><span class="p">(</span><span class="n">main_iter_</span><span class="o">-&gt;</span><span class="n">get_next_row</span><span class="p">(</span><span class="n">row</span><span class="p">)))</span> <span class="p">{</span> <span class="c1">// æ•°æ®è¡¨è·å–åˆ°ä¸€è¡Œæ•°æ®ï¼Œç›´æ¥ç»“æŸ</span>
         <span class="k">break</span><span class="p">;</span>
       <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">OB_ITER_END</span> <span class="o">==</span> <span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
           <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ctx_</span><span class="o">-&gt;</span><span class="n">is_end</span><span class="p">())</span> <span class="p">{</span>
             <span class="n">ret</span> <span class="o">=</span> <span class="n">OB_SUCCESS</span><span class="p">;</span>
           <span class="p">}</span>
           <span class="n">main_iter_</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
         <span class="p">}</span>
 
         <span class="k">if</span> <span class="p">(</span><span class="n">OB_SUCC</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span> <span class="p">{</span>
           <span class="c1">// batch get main table rowkeys from index table</span>
           <span class="c1">// åˆå§‹åŒ–é”®å€¼å‚æ•°ç­‰ç»“æ„ï¼Œå…·ä½“å†…å®¹ç•¥</span>
           <span class="k">for</span> <span class="p">(</span><span class="kt">int64_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">OB_SUCC</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_NUM_PER_BATCH</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
             <span class="k">if</span> <span class="p">(</span><span class="n">OB_FAIL</span><span class="p">(</span><span class="n">index_iter_</span><span class="o">-&gt;</span><span class="n">get_next_row</span><span class="p">(</span><span class="n">index_row</span><span class="p">)))</span> <span class="p">{</span> <span class="c1">// ç´¢å¼•è¡¨è·å–æ•°æ®</span>
               <span class="k">if</span> <span class="p">(</span><span class="n">OB_ARRAY_BINDING_SWITCH_ITERATOR</span> <span class="o">==</span> <span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
                 <span class="o">++</span><span class="n">index_range_array_cursor_</span><span class="p">;</span>
                 <span class="k">if</span> <span class="p">(</span><span class="n">OB_FAIL</span><span class="p">(</span><span class="n">index_iter_</span><span class="o">-&gt;</span><span class="n">switch_iterator</span><span class="p">(</span><span class="n">index_range_array_cursor_</span><span class="p">)))</span> <span class="p">{</span>
                 <span class="p">}</span>
               <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">OB_ITER_END</span> <span class="o">!=</span> <span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
               <span class="p">}</span>
             <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// å­˜å‚¨è·å–çš„æ•°æ®</span>
               <span class="n">src_key</span><span class="p">.</span><span class="n">assign</span><span class="p">(</span><span class="n">index_row</span><span class="o">-&gt;</span><span class="n">row_val_</span><span class="p">.</span><span class="n">cells_</span><span class="p">,</span> <span class="n">rowkey_cnt_</span><span class="p">);</span>
               <span class="k">if</span> <span class="p">(</span><span class="n">OB_FAIL</span><span class="p">(</span><span class="n">src_key</span><span class="p">.</span><span class="n">deep_copy</span><span class="p">(</span><span class="n">dest_key</span><span class="p">.</span><span class="n">get_store_rowkey</span><span class="p">(),</span> <span class="n">rowkey_allocator_</span><span class="p">)))</span> <span class="p">{</span>
               <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                 <span class="n">dest_key</span><span class="p">.</span><span class="n">set_range_array_idx</span><span class="p">(</span><span class="n">index_row</span><span class="o">-&gt;</span><span class="n">range_array_idx_</span><span class="p">);</span>
                 <span class="k">if</span> <span class="p">(</span><span class="n">OB_FAIL</span><span class="p">(</span><span class="n">rowkeys_</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">dest_key</span><span class="p">)))</span> <span class="p">{</span>
                 <span class="p">}</span>
               <span class="p">}</span>
             <span class="p">}</span>
           <span class="p">}</span>
           <span class="k">if</span> <span class="p">(</span><span class="n">OB_SUCC</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span> <span class="p">{</span>
             <span class="k">if</span> <span class="p">(</span><span class="n">OB_FAIL</span><span class="p">(</span><span class="n">table_iter_</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="n">rowkeys_</span><span class="p">)))</span> <span class="p">{</span> <span class="c1">// æ ¹æ®ç´¢å¼•è¡¨çš„æ•°æ®åˆå§‹åŒ–æ•°æ®è¡¨çš„è¿­ä»£å™¨</span>
             <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
               <span class="n">main_iter_</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">table_iter_</span><span class="p">;</span>
             <span class="p">}</span>
           <span class="p">}</span>
         <span class="p">}</span>
       <span class="p">}</span>
     <span class="p">}</span>
   <span class="p">}</span>
   <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
 <span class="p">}</span>
</code></pre></div></div>
<h2 id="æ€»ç»“å¦‚ä½•ä»ä»£ç ç»“æ„ä¸Šå¯¹obçš„æºç è¿›è¡Œåˆ†æ">æ€»ç»“ï¼šå¦‚ä½•ä»ä»£ç ç»“æ„ä¸Šå¯¹OBçš„æºç è¿›è¡Œåˆ†æï¼Ÿ</h2>

<p>æˆ–è®¸å¾ˆå¤šäººä¼šåƒæˆ‘ä»¬ä¸€æ ·ï¼Œåœ¨ä¸€å¼€å§‹çœ‹åˆ°æºç çš„æ—¶å€™ä¸çŸ¥æ‰€æªã€‚æ¯•ç«Ÿï¼ŒOBä½œä¸ºä¸€ä¸ªéå¸¸åºå¤§çš„é¡¹ç›®ï¼Œå¾ˆéš¾å¿«é€Ÿæ‰¾åˆ°å…¥æ‰‹çš„éƒ¨åˆ†ã€‚æ ¹æ®æˆ‘ä»¬çš„ç»éªŒï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸€èˆ¬å¯ä»¥å…ˆä½¿ç”¨perfæ¥å¿«é€Ÿæ‰¾åˆ°æœ€è€—æ—¶çš„æ‰§è¡Œéƒ¨åˆ†ï¼Œè¿™éƒ¨åˆ†ä»£ç å¾€å¾€ä¸æ ¸å¿ƒé€»è¾‘ç´§å¯†ç›¸å…³ï¼Œå¦‚æˆ‘ä»¬ä¸Šè¿°å±•ç¤ºçš„éƒ¨åˆ†ä»£ç ã€‚åœ¨æ­¤åŸºç¡€ä¸Šï¼Œç»“åˆgdb debugï¼Œå¯ä»¥è·å–åˆ°æ‰§è¡Œè¿‡ç¨‹ä¸­çš„ä¸»è¦è°ƒç”¨æ ˆã€‚å¾€å¾€æˆ‘ä»¬ä¼šå‘ç°è°ƒç”¨æ ˆå¾ˆæ·±ï¼Œä½†æ˜¯å…¶ä¸­å¤§éƒ¨åˆ†çš„ä»£ç éƒ½ä¸ä¼šæ¶‰åŠåˆ°æ ¸å¿ƒé€»è¾‘ï¼Œä¸éœ€è¦é€ä¸ªæ·±å…¥åœ°ç ”ç©¶ã€‚å› æ­¤ï¼Œå†é€šè¿‡OBçš„ä»£ç è‡ªæ³¨é‡Šå’ŒåŸºæœ¬çš„æ•°æ®åº“çŸ¥è¯†å¯ä»¥æœ‰æ•ˆåœ°å®šä½åˆ°æ‰€æƒ³è¦ä¿®æ”¹çš„éƒ¨åˆ†ã€‚</p>

<p>å½“å®šä½åˆ°è¦ä¿®æ”¹çš„éƒ¨åˆ†ä¹‹åï¼Œå¦‚ä½•å…·ä½“åœ°åˆ†ææºç çš„é€»è¾‘å‘¢ï¼Ÿé¦–å…ˆéœ€è¦ç†Ÿæ‚‰OBçš„ä»£ç é£æ ¼ï¼Œèƒ½å°†è¿ç»­çš„æ¡ä»¶åµŒå¥—é‡æ–°ç¿»è¯‘ä¸ºé¡ºåºæ‰§è¡Œã€‚ç„¶åé€šè¿‡ä»£ç çš„è‡ªæ³¨é‡Šå»æ„Ÿå—å®ç°çš„åŠŸèƒ½ï¼Œç”±äºOBä¸­å¤§éƒ¨åˆ†çš„ç±»éƒ½å¸¦æœ‰å¾ˆå¤šå±‚çš„åµŒå¥—ï¼Œåœ¨ä¸€å¼€å§‹ä¸æ–­æ·±æŒ–æŸä¸ªç»†èŠ‚å¾ˆå®¹æ˜“æ™•å¤´è½¬å‘ï¼Œé‡‡ç”¨â€œä¸æ±‚ç”šè§£â€çš„æ€åº¦ï¼Œå…ˆå®è§‚ä¸ŠæŠŠæ¡æ•´ä¸ªæ‰§è¡Œæµç¨‹ï¼Œå¯¹äºä»£ç çš„åˆ†æä¼šæ›´æœ‰åˆ©ã€‚åœ¨äº†è§£äº†æ•´ä½“çš„æµç¨‹ä¹‹åï¼Œå†ç»“åˆé€æ­¥è°ƒè¯•å»æ·±å…¥ç†è§£å…¶ä¸­çš„æ‰§è¡Œæµç¨‹ã€‚</p>

<p>å¸Œæœ›ä¸Šè¿°çš„æ–¹æ³•åˆ†äº«ï¼Œèƒ½å¤Ÿå¸®åŠ©å¤§å®¶åˆ†æOBä»£ç ï¼Œä¸ºå¤§å®¶åœ¨å¼€æºç¤¾åŒºä¸­çš„è´¡çŒ®æ·»ç –åŠ ç“¦ã€‚</p>
  </section>

  
  
  

  <section class="background" data-size="page">
    <!--
  background: ;
  dark: ;
  size: ;
-->


<div class="post-nav">
  <span>
    
      <i class="icon fa-solid fa-angle-left"></i> Previous post<br>
      <a href="/2022/05/11/OceanBase%E5%86%85%E6%A0%B8%E5%88%9D%E6%8E%A2.html">
        OceanBaseå†…æ ¸åˆæ¢
      </a>
    
  </span>
  <span>
    
      Next post <i class="icon fa-solid fa-angle-right"></i><br>
      <a href="/2022/05/25/Oceanbase%E4%B8%ADLSM-Tree%E7%9A%84%E5%88%86%E5%B1%82%E8%AE%BE%E8%AE%A1%E5%8F%8A%E5%85%B6%E4%BC%98%E7%BC%BA%E7%82%B9.html">
        Oceanbaseä¸­LSM-Treeçš„åˆ†å±‚è®¾è®¡åŠå…¶ä¼˜ç¼ºç‚¹
      </a>
    
  </span>
</div>
  </section>


    </main>
    


<footer class="background" style="--image: url('')" data-dark="true" data-size="wide">
  <!--
    <div>
      Extra details like contact info or address
    </div>
  -->

  <div>
    
      
      
      



  <div class="button-wrapper">
    <a class="button" href="mailto:rzhang@dase.ecnu.edu.cn" data-tooltip="Email" data-style="bare" aria-label="Email">
      <i class="icon fa-solid fa-envelope"></i>
      
    </a>
  </div>


    
      
      
      



  <div class="button-wrapper">
    <a class="button" href="tel:021-62235006" data-tooltip="Phone number" data-style="bare" aria-label="Phone number">
      <i class="icon fa-solid fa-phone"></i>
      
    </a>
  </div>


    
      
      
      



  <div class="button-wrapper">
    <a class="button" href="https://orcid.org/0000-0002-5182-2093" data-tooltip="ORCID" data-style="bare" aria-label="ORCID">
      <i class="icon fa-brands fa-orcid"></i>
      
    </a>
  </div>


    
      
      
      



  <div class="button-wrapper">
    <a class="button" href="https://scholar.google.com/citations?user=iJtZsaQAAAAJ" data-tooltip="Google Scholar" data-style="bare" aria-label="Google Scholar">
      <i class="icon fa-brands fa-google"></i>
      
    </a>
  </div>


    
      
      
      



  <div class="button-wrapper">
    <a class="button" href="https://github.com/dbhammer" data-tooltip="GitHub" data-style="bare" aria-label="GitHub">
      <i class="icon fa-brands fa-github"></i>
      
    </a>
  </div>


    
  </div>

  <div>
    Â© 2025
    DBHammer
    Â  | Â  Built with
    <a href="https://github.com/greenelab/lab-website-template">
      Lab Website Template
    </a>
  </div>

  <input type="checkbox" class="dark-toggle" data-tooltip="Dark mode" aria-label="toggle dark mode" oninput="onDarkToggleChange(event)">
</footer>

  </body>
</html>
